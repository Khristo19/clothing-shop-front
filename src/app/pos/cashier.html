<div style="padding:1.75rem;display:flex;flex-direction:column;gap:1.5rem;background:#f9fafb;min-height:100vh">
  <header>
    <h1 style="margin:0;font-size:1.75rem;">Point of Sale</h1>
    <p style="margin:.25rem 0 0;color:#6b7280;max-width:520px">
      Scan a barcode or browse the catalog. Confirm stock levels and product photos with the customer before adding items to the cart.
    </p>
  </header>

  <section *ngIf="banner() as toast" [style.background]="toast.tone === 'error' ? '#fee2e2' : '#dcfce7'" style="padding:.75rem 1rem;border-radius:10px;display:flex;align-items:center;justify-content:space-between;color:#111827">
    <span>{{ toast.text }}</span>
    <button (click)="banner.set(null)" style="background:transparent;border:none;color:inherit;font-weight:600;cursor:pointer">×</button>
  </section>

  <div style="display:grid;gap:1.5rem;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));align-items:flex-start">
    <section style="background:#fff;border-radius:16px;padding:1.25rem;box-shadow:0 10px 30px rgba(15,23,42,.08);display:flex;flex-direction:column;gap:1rem">
      <div>
        <h2 style="margin:0;font-size:1.25rem">Inventory</h2>
        <p style="margin:.25rem 0 0;color:#6b7280;font-size:.9rem">Browse the catalog or search, then tap an item to add it to the cart.</p>
      </div>
      <button (click)="togglePicker()" style="align-self:flex-start;padding:.5rem 1rem;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer">
        {{ pickerOpen() ? 'Hide product list' : 'Browse catalog' }}
      </button>

      <div *ngIf="pickerOpen()" style="display:flex;flex-direction:column;gap:1rem">
        <div>
          <input [value]="search()" (input)="search.set(($any($event.target)).value)" placeholder="Search by name or description" style="width:100%;padding:.6rem 1rem;border-radius:10px;border:1px solid #d1d5db" />
        </div>

        <div *ngIf="loadingProducts()" style="padding:1rem;border-radius:10px;background:#eff6ff;color:#1d4ed8">Loading catalog…</div>
        <div *ngIf="productError()" style="padding:1rem;border-radius:10px;background:#fef2f2;color:#991b1b">{{ productError() }}</div>

        <div *ngIf="!loadingProducts() && !productError()" style="max-height:360px;overflow:auto;display:flex;flex-direction:column;gap:.75rem">
          <button *ngFor="let product of filteredProducts(); trackBy: trackProduct" (click)="addProduct(product)" [disabled]="product.stock === 0" style="display:flex;gap:1rem;padding:.75rem;border:1px solid #e5e7eb;border-radius:12px;background:#fff;cursor:pointer;text-align:left">
            <img [src]="product.imageUrl || 'https://via.placeholder.com/80?text=No+Image'" [alt]="product.name" style="width:72px;height:72px;object-fit:cover;border-radius:10px" />
            <div style="flex:1;display:flex;flex-direction:column;gap:.25rem">
              <div style="display:flex;justify-content:space-between;gap:.75rem;align-items:start">
                <h3 style="margin:0;font-size:1rem">{{ product.name }}</h3>
                <span style="font-weight:600">${{ product.price | number:'1.2-2' }}</span>
              </div>
              <p style="margin:0;color:#6b7280;font-size:.85rem">{{ product.description || 'No description provided.' }}</p>
              <span [style.color]="product.stock === 0 ? '#b91c1c' : '#16a34a'" style="font-size:.85rem">{{ product.stock }} in stock</span>
            </div>
          </button>
          <div *ngIf="filteredProducts().length === 0" style="padding:1rem;border-radius:10px;border:1px dashed #d1d5db;text-align:center;color:#6b7280">No items match the current search.</div>
        </div>
      </div>
    </section>

    <section style="background:#fff;border-radius:16px;padding:1.25rem;box-shadow:0 10px 30px rgba(15,23,42,.08);display:flex;flex-direction:column;gap:1rem">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
        <div>
          <h2 style="margin:0;font-size:1.25rem">Cart</h2>
          <p style="margin:.25rem 0 0;color:#6b7280;font-size:.9rem">{{ totalItems() }} items · Total ${{ total() | number:'1.2-2' }}</p>
        </div>
        <button (click)="clearCart()" [disabled]="cart().length === 0" style="padding:.4rem .9rem;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer">Clear</button>
      </div>

      <div *ngIf="cart().length === 0" style="padding:1rem;border:1px dashed #d1d5db;border-radius:12px;text-align:center;color:#6b7280">
        The cart is empty. Select a product from the catalog to get started.
      </div>

      <div *ngFor="let item of cart(); trackBy: trackCart" style="display:flex;gap:1rem;align-items:center;border:1px solid #e5e7eb;border-radius:12px;padding:.75rem">
        <img [src]="item.imageUrl || 'https://via.placeholder.com/64?text=No+Image'" [alt]="item.name" style="width:64px;height:64px;object-fit:cover;border-radius:10px" />
        <div style="flex:1;display:flex;flex-direction:column;gap:.25rem">
          <strong>{{ item.name }}</strong>
          <span style="color:#6b7280;font-size:.85rem">Unit: ${{ item.price | number:'1.2-2' }}</span>
          <span style="color:#6b7280;font-size:.8rem">{{ item.stock - item.qty }} left in stock</span>
        </div>
        <div style="display:flex;align-items:center;gap:.35rem">
          <button (click)="dec(item)" style="width:32px;height:32px;border-radius:999px;border:1px solid #d1d5db;background:#fff">-</button>
          <span style="min-width:24px;text-align:center;font-weight:600">{{ item.qty }}</span>
          <button (click)="inc(item)" [disabled]="item.qty >= item.stock" style="width:32px;height:32px;border-radius:999px;border:1px solid #d1d5db;background:#fff">+</button>
        </div>
        <div style="font-weight:600">${{ (item.price * item.qty) | number:'1.2-2' }}</div>
        <button (click)="remove(item)" style="border:none;background:transparent;color:#dc2626;font-weight:600;cursor:pointer">Remove</button>
      </div>

      <div *ngIf="cart().length" style="display:flex;flex-direction:column;gap:.75rem;border-top:1px solid #e5e7eb;padding-top:1rem">
        <div style="display:flex;justify-content:space-between;color:#6b7280">
          <span>Subtotal</span>
          <span>${{ subtotal() | number:'1.2-2' }}</span>
        </div>
        <div style="display:flex;justify-content:space-between;color:#6b7280">
          <span>Discounts</span>
          <span>${{ discount() | number:'1.2-2' }}</span>
        </div>
        <div style="display:flex;justify-content:space-between;color:#6b7280">
          <span>Tax</span>
          <span>${{ tax() | number:'1.2-2' }}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;font-size:1.1rem;font-weight:600">
          <span>Total</span>
          <span>${{ total() | number:'1.2-2' }}</span>
        </div>

        <div style="display:flex;gap:1rem;flex-wrap:wrap">
          <label style="display:flex;align-items:center;gap:.35rem;padding:.4rem .75rem;border:1px solid #d1d5db;border-radius:999px;cursor:pointer;background:#fff">
            <input type="radio" name="pm" [checked]="payment === 'cash'" (change)="setPayment('cash')" /> Cash
          </label>
          <label [ngStyle]="cardChipStyles()" style="display:flex;align-items:center;gap:.35rem;padding:.4rem .75rem;border-radius:999px;cursor:pointer">
            <input type="radio" name="pm" [checked]="payment === 'card'" (change)="setPayment('card')" /> Card
            <span *ngIf="payment === 'card'">{{ cardBankLabel() }}</span>
          </label>
        </div>

        <div style="display:flex;gap:.75rem;flex-wrap:wrap">
          <button type="button" (click)="openOfferModal()" style="padding:.65rem 1rem;border:1px solid #d1d5db;border-radius:10px;background:#fff;color:#111827;font-weight:600;cursor:pointer">Request admin discount</button>
          <button type="button" (click)="submit()" [disabled]="cart().length === 0" style="padding:.75rem 1.25rem;border:none;border-radius:10px;background:#111827;color:#fff;font-size:1rem;font-weight:600;cursor:pointer">
            Complete sale
          </button>
        </div>
      </div>
    </section>
  </div>

  <!-- Card bank selection -->
  <div *ngIf="cardModalOpen()" style="position:fixed;inset:0;background:rgba(15,23,42,.35);display:flex;align-items:center;justify-content:center;z-index:20">
    <div style="background:#fff;padding:1.5rem;border-radius:16px;max-width:360px;width:100%;display:flex;flex-direction:column;gap:1rem">
      <h3 style="margin:0;font-size:1.25rem">Select acquiring bank</h3>
      <p style="margin:0;color:#6b7280;font-size:.9rem">Choose which bank will process this card payment.</p>
      <div style="display:flex;flex-direction:column;gap:.75rem">
        <button type="button" (click)="confirmCardBank('TBC')" [ngStyle]="cardButtonStyles('TBC')" style="padding:.65rem;border-radius:10px;border:1px solid transparent;cursor:pointer;font-weight:600">TBC Bank</button>
        <button type="button" (click)="confirmCardBank('BOG')" [ngStyle]="cardButtonStyles('BOG')" style="padding:.65rem;border-radius:10px;border:1px solid transparent;cursor:pointer;font-weight:600">Bank of Georgia</button>
      </div>
      <button type="button" (click)="cancelCardSelection()" style="align-self:flex-end;border:none;background:transparent;color:#dc2626;font-weight:600;cursor:pointer">Cancel</button>
    </div>
  </div>

  <!-- Offer request modal -->
  <div *ngIf="offerModalOpen()" style="position:fixed;inset:0;background:rgba(15,23,42,.35);display:flex;align-items:center;justify-content:center;z-index:30">
    <div style="background:#fff;padding:1.5rem;border-radius:16px;max-width:520px;width:100%;display:flex;flex-direction:column;gap:1rem">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0;font-size:1.25rem">Request admin discount</h3>
        <button type="button" (click)="closeOfferModal()" style="border:none;background:transparent;font-weight:600;cursor:pointer">×</button>
      </div>
      <form [formGroup]="offerForm" (ngSubmit)="submitOffer()" style="display:flex;flex-direction:column;gap:1rem">
        <label style="display:flex;flex-direction:column;gap:.35rem">
          <span style="font-weight:600">Shop / Counter</span>
          <input formControlName="from_shop" placeholder="POS Front Desk" />
        </label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <label style="display:flex;flex-direction:column;gap:.35rem">
            <span style="font-weight:600">Discount type</span>
            <select formControlName="discount_type">
              <option value="percentage">Percentage</option>
              <option value="amount">Fixed amount</option>
            </select>
          </label>
          <label style="display:flex;flex-direction:column;gap:.35rem">
            <span style="font-weight:600">Value</span>
            <input formControlName="discount_value" type="number" min="0" />
          </label>
        </div>
        <label style="display:flex;flex-direction:column;gap:.35rem">
          <span style="font-weight:600">Notes to admin</span>
          <textarea formControlName="notes" rows="3" placeholder="Add any context—customer loyalty, bundle, etc."></textarea>
        </label>
        <div style="display:flex;justify-content:flex-end;gap:.75rem">
          <button type="button" (click)="closeOfferModal()" style="padding:.6rem 1.1rem;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer">Cancel</button>
          <button type="submit" [disabled]="offerSubmitting()" style="padding:.6rem 1.1rem;border:none;border-radius:10px;background:#111827;color:#fff;font-weight:600;cursor:pointer">
            {{ offerSubmitting() ? 'Sending…' : 'Send to admin' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
